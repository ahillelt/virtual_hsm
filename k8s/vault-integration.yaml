# HashiCorp Vault Integration for Kubernetes
# This file shows how to integrate Virtual HSM with Vault for secrets management

---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: vhsm-vault-sa
  namespace: vhsm
---
# Vault Agent ConfigMap
apiVersion: v1
kind: ConfigMap
metadata:
  name: vault-agent-config
  namespace: vhsm
data:
  vault-agent-config.hcl: |
    exit_after_auth = false
    pid_file = "/tmp/pidfile"

    auto_auth {
      method "kubernetes" {
        mount_path = "auth/kubernetes"
        config = {
          role = "vhsm-role"
        }
      }

      sink "file" {
        config = {
          path = "/vault/secrets/token"
        }
      }
    }

    template {
      source      = "/vault/configs/master-key.tmpl"
      destination = "/vault/secrets/master-key"
    }

    template {
      source      = "/vault/configs/admin-password.tmpl"
      destination = "/vault/secrets/admin-password"
    }
---
# Deployment with Vault Agent Sidecar
apiVersion: apps/v1
kind: Deployment
metadata:
  name: vhsm-with-vault
  namespace: vhsm
spec:
  replicas: 2
  selector:
    matchLabels:
      app: vhsm-vault
  template:
    metadata:
      labels:
        app: vhsm-vault
      annotations:
        vault.hashicorp.com/agent-inject: "true"
        vault.hashicorp.com/role: "vhsm-role"
        vault.hashicorp.com/agent-inject-secret-master-key: "secret/data/vhsm/master-key"
        vault.hashicorp.com/agent-inject-secret-admin-password: "secret/data/vhsm/admin-password"
        vault.hashicorp.com/agent-inject-template-master-key: |
          {{- with secret "secret/data/vhsm/master-key" -}}
          {{ .Data.data.key }}
          {{- end }}
        vault.hashicorp.com/agent-inject-template-admin-password: |
          {{- with secret "secret/data/vhsm/admin-password" -}}
          {{ .Data.data.password }}
          {{- end }}
    spec:
      serviceAccountName: vhsm-vault-sa
      containers:
      - name: vhsm
        image: virtual-hsm:latest
        env:
        - name: VHSM_MASTER_KEY_FILE
          value: /vault/secrets/master-key
        - name: VHSM_ADMIN_PASSWORD_FILE
          value: /vault/secrets/admin-password
        volumeMounts:
        - name: vault-secrets
          mountPath: /vault/secrets
          readOnly: true
      volumes:
      - name: vault-secrets
        emptyDir:
          medium: Memory
